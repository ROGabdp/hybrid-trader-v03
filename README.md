# ğŸš€ Hybrid Trading System for Taiwan Stock Index (^TWII)

é€™æ˜¯ä¸€å€‹å…ˆé€²çš„æ¼”ç®—æ³•äº¤æ˜“ç³»çµ±ï¼Œçµåˆäº†ç”¨æ–¼åƒ¹æ ¼é æ¸¬çš„ **LSTM-SSAM** (Long Short-Term Memory with Sequential Self-Attention) ä»¥åŠç”¨æ–¼äº¤æ˜“æ±ºç­–çš„ **Pro Trader RL** (Reinforcement Learning)ã€‚

## âœ¨ æ ¸å¿ƒç‰¹è‰² (Key Features)

| ç‰¹è‰² | èªªæ˜ |
|---------|-------------|
| **æœ¬åœ°è³‡æ–™æ•´åˆ** | TWII æ­·å²è³‡æ–™æ¡æœ¬åœ° CSV ç®¡ç† (`twii_data_from_2000_01_01.csv`)ï¼Œç¢ºä¿æˆäº¤é‡å–®ä½ (å„„å…ƒ) æ­£ç¢ºï¼Œä¸¦å…·å‚™è‡ªå‹•æ›´æ–°æ©Ÿåˆ¶ |
| **åš´è¬¹è¨“ç·´æµç¨‹** | **Data Leakage Prevention**: LSTM æ¨¡å‹è¨“ç·´æ™‚çš„è³‡æ–™ç¸®æ”¾ (Scaling) åš´æ ¼é™åˆ¶åœ¨è¨“ç·´é›†å…§ï¼Œé˜²æ­¢ Look-ahead Bias |
| **LSTM-SSAM é æ¸¬** | T+1 èˆ‡ T+5 åƒ¹æ ¼é æ¸¬ï¼Œä¸¦ä½¿ç”¨ MC Dropout é€²è¡Œä¸ç¢ºå®šæ€§ä¼°è¨ˆ |
| **é·ç§»å­¸ç¿’ (Transfer Learning)** | ä½¿ç”¨å…¨çƒæŒ‡æ•¸é€²è¡Œé è¨“ç·´ (Pre-train) â†’ é‡å° ^TWII é€²è¡Œå¾®èª¿ (Fine-tune) |
| **ç‰¹å¾µèåˆ (Feature Fusion)** | æ•´åˆ 24 ç¨®ç‰¹å¾µï¼ŒåŒ…å« LSTM é æ¸¬å€¼èˆ‡ä¿¡å¿ƒåˆ†æ•¸ (T+1/T+5) |
| **PPO Agent** | åˆ†é›¢çš„è²·å…¥ (Buy) èˆ‡è³£å‡º (Sell) ä»£ç†äººï¼Œä¸¦å…·å‚™é¡åˆ¥å¹³è¡¡æ©Ÿåˆ¶ |
| **å›æ¸¬ (Backtesting)** | å®Œæ•´çš„æ¨¡æ“¬å›æ¸¬ï¼ŒåŒ…å«åœææ©Ÿåˆ¶èˆ‡ç¸¾æ•ˆæŒ‡æ¨™è¨ˆç®— |

## ğŸ“Š ç¸¾æ•ˆçµæœ (2023-Present)

| æŒ‡æ¨™ (Metric) | æ•¸å€¼ (Value) |
|--------|-------|
| **ç¸½å ±é…¬ç‡ (ROI)** | 85.49% |
| **å¹´åŒ–å ±é…¬ç‡ (Annualized Return)** | 23.53% |
| **å¤æ™®å€¼ (Sharpe Ratio)** | 1.47 |
| **æœ€å¤§å›æ’¤ (Max Drawdown)** | -17.23% |
| **å‹ç‡ (Win Rate)** | 100% (5 æ¬¡äº¤æ˜“) |

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹ (Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HYBRID TRADING SYSTEM                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  LSTM T+1    â”‚    â”‚  LSTM T+5    â”‚    â”‚    æŠ€è¡“æŒ‡æ¨™       â”‚  â”‚
â”‚  â”‚   é æ¸¬æ¨¡å‹    â”‚    â”‚  + MC Dropoutâ”‚    â”‚  (Indicators)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                   â”‚                      â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                             â”‚                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚    23 ç‰¹å¾µèåˆ   â”‚                          â”‚
â”‚                    â”‚  (Feature Fusion)â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                             â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â”‚                                       â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Buy Agent  â”‚                        â”‚  Sell Agent â”‚        â”‚
â”‚  â”‚    (PPO)    â”‚                        â”‚    (PPO)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                                      â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                            â”‚                                     â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                   â”‚    äº¤æ˜“è¨Šè™Ÿ      â”‚                           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹ (Project Structure)

```
hybrid-trader-v02/
â”œâ”€â”€ ptrl_hybrid_system.py        # æ ¸å¿ƒç³»çµ± (è³‡æ–™è¼‰å…¥/ç‰¹å¾µè¨ˆç®—/è¨“ç·´é‚è¼¯)
â”œâ”€â”€ update_twii_data.py          # è³‡æ–™æ›´æ–°è…³æœ¬ (è‡ªå‹•æŠ“å–æœ€æ–° TWII æ•¸æ“š)
â”œâ”€â”€ twii_data_from_2000_01_01.csv # æœ¬åœ° TWII æ­·å²è³‡æ–™åº« (Volume: å„„å…ƒ)
â”œâ”€â”€ train_v3_models.py           # V3 è¨“ç·´è…³æœ¬ (ä½¿ç”¨æœ¬åœ°è³‡æ–™)
â”œâ”€â”€ train_v4_models.py           # V4 è¨“ç·´è…³æœ¬ (ä½¿ç”¨æœ¬åœ°è³‡æ–™)
â”œâ”€â”€ daily_ops_dual.py            # æ¯æ—¥ç¶­é‹ (ç›¤å¾Œ)
â”œâ”€â”€ daily_ops_dual_intraday.py   # ç›¤ä¸­å³æ™‚åˆ†æ (å®Œæ•´ LSTM è¨“ç·´+é æ¸¬)
â”œâ”€â”€ backtest_v3_no_filter.py     # V3 å›æ¸¬ (ä½¿ç”¨æœ¬åœ°è³‡æ–™)
â”œâ”€â”€ backtest_v4_no_filter.py     # V4 å›æ¸¬ (ä½¿ç”¨æœ¬åœ°è³‡æ–™)
â””â”€â”€ backtest_v4_dca_hybrid_no_filter.py # DCA æ··åˆå›æ¸¬ (ä½¿ç”¨æœ¬åœ°è³‡æ–™)
```

## ğŸ› ï¸ å®‰è£èªªæ˜ (Installation)

### å»ºè­°ä½¿ç”¨è™›æ“¬ç’°å¢ƒ (Virtual Environment)
åœ¨ Windows ä¸Šä½¿ç”¨è™›æ“¬ç’°å¢ƒå¯ä»¥é¿å…å¥—ä»¶ç‰ˆæœ¬è¡çªï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨ã€‚

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•è…³æœ¬ (æ¨è–¦)**
```powershell
.\setup_env.ps1
```

**æ–¹æ³•äºŒï¼šæ‰‹å‹•è¨­å®š**
```powershell
# 1. å»ºç«‹è™›æ“¬ç’°å¢ƒ
python -m venv venv

# 2. å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
.\venv\Scripts\Activate.ps1

# 3. å®‰è£å¥—ä»¶
pip install -r requirements.txt
```

### âš¡ GPU åŠ é€Ÿè¨­å®š (é‡è¦)
æœ¬å°ˆæ¡ˆå»ºè­°ä½¿ç”¨ NVIDIA é¡¯å¡é€²è¡Œè¨“ç·´åŠ é€Ÿã€‚

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨ setup_env.ps1 (è‡ªå‹•)**
è…³æœ¬æœƒè‡ªå‹•å®‰è£æ”¯æ´ CUDA 11.8 çš„ PyTorch ç‰ˆæœ¬ã€‚

**æ–¹æ³•äºŒï¼šæ‰‹å‹•å®‰è£**
è‹¥æ‚¨æ‰‹å‹•åŸ·è¡Œ `pip install -r requirements.txt`ï¼Œé è¨­æœƒå®‰è£ CPU ç‰ˆæœ¬ã€‚è«‹åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å°‡å…¶æ›¿æ›ç‚º GPU ç‰ˆæœ¬ï¼š

```powershell
# 1. ç§»é™¤ CPU ç‰ˆæœ¬
pip uninstall torch torchvision torchaudio -y

# 2. å®‰è£ GPU ç‰ˆæœ¬ (CUDA 11.8)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### ç³»çµ±éœ€æ±‚ (Dependencies)

```
tensorflow>=2.10
stable-baselines3>=2.0
gymnasium
yfinance
pandas
numpy
ta
torch
tqdm
matplotlib
psutil
```

## ğŸš€ å¿«é€Ÿé–‹å§‹ (Quick Start)

### 1. è¨“ç·´ LSTM æ¨¡å‹ (é•·é€±æœŸ)

```bash
python train_lstm_models.py
```

### 2. è¨“ç·´ RL æ¨¡å‹ (V3 vs V4)

æœ¬å°ˆæ¡ˆæä¾›å…©å€‹ç‰ˆæœ¬çš„ RL è¨“ç·´è…³æœ¬ï¼Œè«‹ä¾éœ€æ±‚é¸æ“‡ï¼š

| ç‰¹æ€§ | V3 (Lightweight) | V4 (Standard) |
|------|------------------|---------------|
| **ç”¨é€”** | è¼•é‡ç‰ˆï¼Œé©åˆå¿«é€Ÿå¯¦é©— | æ¨™æº–ç‰ˆï¼Œé©åˆå®Œæ•´è¨“ç·´ |
| **Buy Fine-tune** | 200,000 æ­¥ | 1,000,000 æ­¥ |
| **Sell Fine-tune** | 100,000 æ­¥ | 300,000 æ­¥ |
| **æŒ‡ä»¤** | `python train_v3_models.py` | `python train_v4_models.py` |
| **è¼¸å‡ºç›®éŒ„** | `models_hybrid_v3/` | `models_hybrid_v4/` |

### 3. æ¯æ—¥ç¶­é‹ (Daily Operations)

è‡ªå‹•åŒ–è…³æœ¬èƒ½å®Œæˆã€ŒLSTM é‡è¨“ â†’ ç‰¹å¾µå·¥ç¨‹ â†’ RL æ¨è«– â†’ å ±å‘Šç”Ÿæˆã€å…¨æµç¨‹ã€‚

#### ğŸ“Œ ç›¤å¾Œåˆ†æ (æ”¶ç›¤å¾ŒåŸ·è¡Œ)

- **é›™ç­–ç•¥æ¯”è¼ƒ (æ¨è–¦)**: åŒæ™‚åŸ·è¡Œ V3 èˆ‡ V4 æ¨¡å‹ä¸¦ç”¢ç”Ÿç¶œåˆå»ºè­°ã€‚
  ```bash
  python daily_ops_dual.py
  ```

- **å–®ç­–ç•¥é‹è¡Œ**:
  ```bash
  python daily_ops_v3.py  # åƒ… V3
  python daily_ops_v4.py  # åƒ… V4
  ```

**è¼¸å‡ºç›®éŒ„**: `daily_runs/YYYY-MM-DD/`

#### â±ï¸ ç›¤ä¸­å³æ™‚åˆ†æ (äº¤æ˜“æ™‚æ®µå…§åŸ·è¡Œ)

```bash
python daily_ops_dual_intraday.py
```

**æµç¨‹èªªæ˜ï¼š**
1. å¾**è­‰äº¤æ‰€ç›¤ä¸­ API** (`mis.twse.com.tw`) ä¸‹è¼‰ç•¶æ—¥å³æ™‚ OHLC *(2025-12-12 æ›´æ–°)*
2. ä½¿ç”¨ CSV å‰ 5 æ—¥æˆäº¤é‡å¹³å‡ä½œç‚ºç•¶æ—¥é ä¼°æˆäº¤é‡
3. ä½¿ç”¨ä¸Šè¿°è³‡æ–™å®Œæ•´è¨“ç·´ LSTM æ¨¡å‹ (T+5 åŠ T+1)
4. é€²è¡Œ V3/V4 é›™ç­–ç•¥æ¨è«–ä¸¦è¼¸å‡ºå ±å‘Š

**ç‰¹é»ï¼š**
- âœ… **å³æ™‚è³‡æ–™**ï¼šä½¿ç”¨è­‰äº¤æ‰€ API å–å¾—çœŸæ­£çš„ç›¤ä¸­åƒ¹æ ¼ï¼ˆyfinance æœ‰ 15+ åˆ†é˜å»¶é²ï¼‰
- âœ… ç¨ç«‹é‹ä½œï¼Œ**ä¸éœ€å…ˆåŸ·è¡Œ daily_ops_dual.py**
- âœ… **ä¸ä¿®æ”¹åŸå§‹ CSV** (ä½¿ç”¨ CSV äº¤æ›ç­–ç•¥ï¼šå‚™ä»½ â†’ è¨“ç·´ â†’ æ¢å¾©)
- âœ… è¼¸å‡ºåˆ°ç¨ç«‹è³‡æ–™å¤¾ `intraday_runs/YYYY-MM-DD_HHMMSS/`
- â° åŸ·è¡Œæ™‚é–“ç´„ 20-40 åˆ†é˜ (LSTM è¨“ç·´æ™‚é–“)

**è¼¸å‡ºç›®éŒ„çµæ§‹ï¼š**
```
intraday_runs/2025-12-11_120731/
â”œâ”€â”€ lstm_models/          # ç›¤ä¸­è¨“ç·´çš„ LSTM æ¨¡å‹
â”œâ”€â”€ cache/                # æš«å­˜è³‡æ–™
â””â”€â”€ reports/
    â”œâ”€â”€ intraday_summary.txt
    â””â”€â”€ intraday_summary.json
```

---

**åŠŸèƒ½ç‰¹é» (v2.7)ï¼š**
- **å…¨æ™‚æ¨è«–æ¨¡å¼**: ç„¡è«– Donchian æ¿¾ç¶²ç‹€æ…‹ï¼ŒAI éƒ½æœƒåŸ·è¡Œé æ¸¬ä¸¦é¡¯ç¤ºæ„åœ–
- **æ¿¾ç¶²ç‹€æ…‹æ¨™è¨˜**: `BUY`, `WAIT`, `FILTERED (AI: BUY)`, `FILTERED (AI: WAIT)`
- **æƒ…å¢ƒåˆ†æ**: Sell Agent é‡å°ä¸‰ç¨®æŒå€‰æƒ…å¢ƒ (æˆæœ¬å€/ç²åˆ©+10%/è™§æ-5%) æä¾›å»ºè­°
- **æ•¸æ“šåŒ¯å‡º**: è‡ªå‹•åŒ¯å‡º `raw_data.csv` å’Œ `processed_features.csv` ä¾›é™¤éŒ¯æª¢æŸ¥
- **çµ±ä¸€è¨“ç·´å¤©æ•¸**: ä¸‰å€‹ daily_ops è…³æœ¬å‡ä½¿ç”¨ T+5/2200å¤©, T+1/2000å¤©
- è¼¸å‡º JSON èˆ‡ TXT æˆ°æƒ…å ±å‘Š

### 4. ç„¡æ¿¾ç¶²å›æ¸¬ (No-Filter Backtest)

æ¸¬è©¦ AI åœ¨æ¯å¤©éƒ½å¯é€²å ´ (ç„¡ Donchian æ¿¾ç¶²é™åˆ¶) çš„æƒ…æ³ä¸‹çš„ç¸¾æ•ˆï¼š

```bash
python backtest_v3_no_filter.py  # V3 ç„¡æ¿¾ç¶²å›æ¸¬
python backtest_v4_no_filter.py  # V4 ç„¡æ¿¾ç¶²å›æ¸¬
```

**åŠŸèƒ½ç‰¹é» (v2.9)ï¼š**

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **è‡ªè¨‚æ—¥æœŸç¯„åœ** | é€é `--start` å’Œ `--end` åƒæ•¸æŒ‡å®šå›æ¸¬æœŸé–“ |
| **å‹•æ…‹æª”å** | è¼¸å‡ºæª”æ¡ˆè‡ªå‹•åŒ…å«æ—¥æœŸç¯„åœï¼Œé¿å…è¦†è“‹ |
| **Benchmark æ¯”è¼ƒ** | ç­–ç•¥ç¸¾æ•ˆ vs Buy & Hold ä¸¦æ’é¡¯ç¤º |
| **ç¸¾æ•ˆæ‘˜è¦** | æ§åˆ¶å°ã€åœ–è¡¨ã€CSV ä¸‰è™•åŒæ­¥é¡¯ç¤º |

**ä½¿ç”¨ç¯„ä¾‹ï¼š**
```bash
# é è¨­æ—¥æœŸ (2023-01-01 è‡³ä»Š)
python backtest_v4_no_filter.py

# è‡ªè¨‚é–‹å§‹æ—¥æœŸ
python backtest_v4_no_filter.py --start 2020-01-01

# è‡ªè¨‚å®Œæ•´æ—¥æœŸç¯„åœ
python backtest_v4_no_filter.py --start 2015-01-01 --end 2023-12-31
```

### 5. DCA + AI æ··åˆç­–ç•¥å›æ¸¬

æ¸¬è©¦ã€Œå®šæœŸå®šé¡ + AI è‡ªç”±æ“ä½œã€æ··åˆç­–ç•¥çš„ç¸¾æ•ˆï¼š

```bash
python backtest_v4_dca_hybrid_no_filter.py
```

**ç­–ç•¥èªªæ˜ï¼š**
- æ¯å¹´å¹´åˆç²å¾— 60 è¬æ–°è³‡é‡‘
- 50% åˆ† 12 å€‹æœˆå®šæœŸå®šé¡æŠ•å…¥ (è²·å…¥å¾Œä¸è³£)
- 50% ç”± AI è‡ªç”±æ±ºå®šè²·è³£æ™‚æ©Ÿ

**æ¯”è¼ƒåŸºæº–ï¼š**
1. ç´”å®šæœŸå®šé¡ï¼šæ¯æœˆ 5 è¬å…ƒ
2. å¹´åˆä¸€æ¬¡æŠ•å…¥ï¼šæ¯å¹´ 60 è¬ Buy & Hold

**è¼¸å‡ºæª”æ¡ˆï¼š**
```
results_backtest_v4_dca_hybrid_no_filter/
â”œâ”€â”€ backtest_v4_dca_hybrid_no_filter_20240102_20251205.png
â”œâ”€â”€ metrics_v4_dca_hybrid_no_filter_20240102_20251205.csv
â””â”€â”€ trades_v4_dca_hybrid_no_filter_20240102_20251205.csv
```

### ğŸ” å›æ¸¬è…³æœ¬åŠŸèƒ½æ¯”è¼ƒ

| åŠŸèƒ½ | `backtest_v3_no_filter.py` | `backtest_v4_no_filter.py` | `backtest_v4_dca_hybrid_no_filter.py` |
|------|:---:|:---:|:---:|
| è‡ªè¨‚æ—¥æœŸç¯„åœ | âœ… | âœ… | âœ… |
| å‹•æ…‹æª”å | âœ… | âœ… | âœ… |
| Benchmark æ¯”è¼ƒ | âœ… | âœ… | âœ… |
| DCA + AI æ··åˆç­–ç•¥ | âŒ | âŒ | âœ… |
| **LSTM æ¨¡å‹æ—¥æœŸç¯©é¸** | âœ… (v3.0) | âœ… (v3.0) | âœ… |

> [!IMPORTANT]
> **LSTM æ¨¡å‹æ—¥æœŸç¯©é¸ (v3.0 æ›´æ–°)**ï¼šæ‰€æœ‰å›æ¸¬è…³æœ¬ç¾åœ¨éƒ½æœƒæ ¹æ“šå›æ¸¬ `start_date` ä¾†é¸æ“‡ LSTM æ¨¡å‹ï¼Œç¢ºä¿åªä½¿ç”¨ `train_end < start_date` çš„æ¨¡å‹ï¼Œé¿å…è³‡æ–™æ´©æ¼ (look-ahead bias)ã€‚

## ğŸ“ˆ è¨“ç·´æµç¨‹ (Training Pipeline)

### Phase 1: æ•¸æ“šæ•´åˆ (Unified Data Source)
- **æœ¬åœ°æ•¸æ“š**: ^TWII ä½¿ç”¨æœ¬åœ° `twii_data_from_2000_01_01.csv`ï¼Œç¢ºä¿æˆäº¤é‡å–®ä½æ­£ç¢º (å„„å…ƒ)ã€‚
- **è‡ªå‹•æ›´æ–°**: ç³»çµ±è‡ªå‹•æª¢æŸ¥ä¸¦é€é `update_twii_data.py` è£œé½Šæœ€æ–°äº¤æ˜“æ—¥è³‡æ–™ã€‚
- **åœ‹éš›æŒ‡æ•¸**: ä¸‹è¼‰ 4 å€‹å…¨çƒæŒ‡æ•¸ï¼š^GSPC, ^IXIC, ^SOX, ^DJI (from yfinance)
- **å½±éŸ¿ç¯„åœ**: æ¶µè“‹ V3/V4 è¨“ç·´ã€æ‰€æœ‰å›æ¸¬è…³æœ¬ä»¥åŠæ¯æ—¥ç¶­é‹è…³æœ¬ (Daily Ops)ã€‚

### Phase 2: ç‰¹å¾µå·¥ç¨‹ (Feature Engineering)
- åŒ…å« 24 ç¨®ç‰¹å¾µ (v3.0 æ›´æ–°)ï¼š
  - æ¨™æº–åŒ– OHLC åƒ¹æ ¼
  - å”å¥‡å®‰é€šé“ (Donchian Channel)ã€è¶…ç´šè¶¨å‹¢ (SuperTrend)
  - å¹³å‡Kç·š (Heikin-Ashi) å‹æ…‹
  - RSI, MFI, ATR æŒ‡æ¨™
  - ç›¸å°å¼·åº¦ (Relative Strength) æŒ‡æ¨™
  - **LSTM_Pred_1d**: T+1 é æ¸¬æ¼²å¹…
  - **LSTM_Conf_1d**: T+1 ä¿¡å¿ƒåº¦ (MC Dropout) âœ¨ NEW
  - **LSTM_Pred_5d**: T+5 é æ¸¬æ¼²å¹…
  - **LSTM_Conf_5d**: T+5 ä¿¡å¿ƒåº¦ (MC Dropout)

### Phase 3: é è¨“ç·´ (Pre-training)
- Buy Agent: 1,000,000 æ­¥ (é¡åˆ¥å¹³è¡¡æ¡æ¨£)
- Sell Agent: 500,000 æ­¥

### Phase 4: å¾®èª¿èˆ‡å›æ¸¬ (Fine-tuning & Backtesting)
- å¾®èª¿ï¼šé‡å° ^TWII (2000-2022) é€²è¡Œè¨“ç·´ï¼ŒLearning Rate = 1e-5
- å›æ¸¬ï¼šé©—è­‰æ•¸æ“šé›† (2023-Present)

### âš ï¸ è³‡æ–™ç´€å¾‹ (Data Discipline)

> [!IMPORTANT]
> **é˜²æ­¢è³‡æ–™æ´©æ¼ (Data Leakage Prevention)**
> 
> æœ¬ç³»çµ±æ¡ç”¨åš´æ ¼çš„æ™‚é–“åˆ‡åˆ†ç­–ç•¥ï¼Œç¢ºä¿æ¨¡å‹åœ¨è¨“ç·´æ™‚ä¸æœƒçœ‹åˆ°é©—è­‰æœŸçš„è³‡æ–™ã€‚

| éšæ®µ | è³‡æ–™ç¯„åœ | èªªæ˜ |
|------|----------|------|
| **LSTM è¨“ç·´** | 2000-01-01 ~ 2022-12-31 | ä½¿ç”¨ `train_lstm_models.py` è¨­å®šçš„ `TRAIN_END` |
| **RL é è¨“ç·´** | 2000-01-01 ~ 2022-12-31 | å…¨çƒæŒ‡æ•¸ (^TWII, ^GSPC, ^IXIC, ^SOX, ^DJI) æˆªæ­¢æ–¼ `SPLIT_DATE` |
| **RL å¾®èª¿** | ^TWII < 2023-01-01 | åªç”¨ `SPLIT_DATE` ä¹‹å‰çš„ TWII è³‡æ–™ |
| **RL é©—è­‰/å›æ¸¬** | ^TWII >= 2023-01-01 | æ¨¡å‹å®Œå…¨æ²’è¦‹éçš„è³‡æ–™ |

**é—œéµè¨­å®š (2025-12-11 æ›´æ–°)ï¼š**
```python
# train_lstm_models.py
TRAIN_END = "2022-12-31"

# train_v3_models.py / train_v4_models.py
SPLIT_DATE = '2023-01-01'
raw_data = hybrid.fetch_index_data(DATA_PATH, start_date="2000-01-01", end_date=SPLIT_DATE)
```

**æ™‚é–“ç·šè¦–è¦ºåŒ–ï¼š**
```
LSTM è¨“ç·´æœŸ:      2000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2022-12-31
RL è¨“ç·´/å¾®èª¿æœŸ:   2000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2022-12-31
                                                     â”‚
RL é©—è­‰/å›æ¸¬æœŸ:                                2023-01-01 â”€â”€â”€â”€â”€â”€â”€ ä»Šå¤©
                                               (æ¨¡å‹æœªè¦‹é)
```

### Phase 5: è¨“ç·´ç›£æ§ (Training Monitoring)
æœ¬ç³»çµ±æ•´åˆäº† **TensorBoard** é€²è¡Œè¨“ç·´éç¨‹çš„å³æ™‚ç›£æ§ã€‚

**è‡ªå‹•è¨˜éŒ„çš„æŒ‡æ¨™ï¼š**
- `rollout/ep_rew_mean`: å¹³å‡çå‹µ
- `train/loss`: ç¸½æå¤±
- `train/policy_gradient_loss`: ç­–ç•¥æ¢¯åº¦æå¤±
- `train/value_loss`: åƒ¹å€¼å‡½æ•¸æå¤±
- `train/entropy_loss`: ç†µæå¤±
- `eval/mean_reward`: é©—è­‰é›†å¹³å‡çå‹µ (EvalCallback)

**å¦‚ä½•ä½¿ç”¨ TensorBoardï¼š**
```powershell
# åœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹åŸ·è¡Œ
tensorboard --logdir ./tensorboard_logs/

# ç„¶å¾Œé–‹å•Ÿç€è¦½å™¨å‰å¾€
# http://localhost:6006
```

**æ—¥èªŒå­˜æ”¾ä½ç½®ï¼š**
- `./tensorboard_logs/`: TensorBoard æ—¥èªŒ
- `./logs/`: EvalCallback è©•ä¼°çµæœ
- `models_hybrid/best_tuned/`: é©—è­‰é›†æœ€ä½³æ¨¡å‹

---

## ğŸ“Š è¼¸å‡ºçµæœ (Output)

åŸ·è¡Œ `ptrl_hybrid_system.py` å¾Œï¼Œæ‚¨å°‡ç²å¾—ï¼š

- `models_hybrid/ppo_buy_twii_final.zip`: å¾®èª¿å¾Œçš„ Buy Model
- `models_hybrid/ppo_sell_twii_final.zip`: å¾®èª¿å¾Œçš„ Sell Model
- `results_hybrid/final_performance.png`: ç¸¾æ•ˆåœ–è¡¨
- `tensorboard_logs/`: è¨“ç·´éç¨‹æ—¥èªŒ (å¯ç”¨ TensorBoard æŸ¥çœ‹)

## ğŸ”§ V3 vs V4 ç‰ˆæœ¬æ¯”è¼ƒ

| é …ç›® | V3 (Lightweight) | V4 (Standard) | åŸå§‹ç‰ˆ (ptrl_hybrid_system.py) |
|-----|------------------|-----------------|--------------------------------|
| **Pre-train Buy** | 1,000,000 | 1,000,000 | 1,000,000 |
| **Pre-train Sell** | 500,000 | 500,000 | 500,000 |
| **Fine-tune Buy** | **200,000** | **1,000,000** | 1,000,000 |
| **Fine-tune Sell** | **100,000** | **300,000** | 300,000 |
| **ä¿¡å¿ƒåº¦é–€æª»** | [0.001, 0.010] v2.5 | [0.001, 0.010] v2.5 | [0.005, 0.015] (èˆŠç‰ˆ) |
| **ç‰¹å¾µå¿«å–** | å¼·åˆ¶æ¸…é™¤ | å¼·åˆ¶æ¸…é™¤ | ä½¿ç”¨å¿«å– (éœ€æ‰‹å‹•æ¸…é™¤) |
| **æ¨¡å‹è·¯å¾‘** | `models_hybrid_v3` | `models_hybrid_v4` | `models_hybrid` |

---

## ğŸ”® LSTM ä¿¡å¿ƒåº¦è§£è®€æŒ‡å— (Confidence Interpretation)

### è¨ˆç®—åŸç† (Methodology)
ä¿¡å¿ƒåº¦ (`LSTM_Conf_1d`, `LSTM_Conf_5d`) æ˜¯åŸºæ–¼ **è’™åœ°å¡ç¾… Dropout (MC Dropout)** è¨ˆç®—çš„ï¼š
1. å°åŒä¸€ç­†è³‡æ–™é€²è¡Œ 30 æ¬¡é æ¸¬ï¼ˆæ¯æ¬¡ Dropout éš¨æ©Ÿé®è”½ä¸åŒç¥ç¶“å…ƒï¼‰
2. è¨ˆç®—é€™ 30 æ¬¡é æ¸¬çš„**è®Šç•°ä¿‚æ•¸ (CV)** = æ¨™æº–å·® Ã· å¹³å‡å€¼
3. CV è¶Šå° â†’ æ¨¡å‹è¶Šç©©å®š â†’ ä¿¡å¿ƒåº¦è¶Šé«˜

### é–€æª»è¨­å®š (v3.0)

| æ¨¡å‹ | threshold_high | threshold_low | èªªæ˜ |
|------|----------------|---------------|------|
| **T+1** | 0.008 (0.8%) | 0.040 (4.0%) | ç¯„åœè¼ƒå¯¬ï¼Œé©æ‡‰è¼ƒé«˜çš„ CV åˆ†ä½ˆ |
| **T+5** | 0.001 (0.1%) | 0.010 (1.0%) | ç¯„åœè¼ƒçª„ï¼Œæ¨¡å‹æœ¬èº«è¼ƒç©©å®š |

```python
# ptrl_hybrid_system.py add_lstm_features()
# T+1 ä¿¡å¿ƒåº¦
score_1d = 1.0 - (cv - 0.008) / (0.040 - 0.008)
conf_1d = np.clip(score_1d, 0.0, 1.0)

# T+5 ä¿¡å¿ƒåº¦
score_5d = 1.0 - (cv - 0.001) / (0.010 - 0.001)
conf_5d = np.clip(score_5d, 0.0, 1.0)
```

### åˆ†æ•¸å°ç…§è¡¨

| ä¿¡å¿ƒåº¦ | è§£è®€ | å»ºè­° |
|--------|------|------|
| **0.8+** | ğŸŸ¢ **é«˜ä¿¡å¿ƒ** - æ¨¡å‹éå¸¸ç¢ºå®š | é æ¸¬å¯é åº¦é«˜ï¼Œå¯ä½œç‚ºä¸»è¦åƒè€ƒ |
| **0.6-0.8** | ğŸŸ¡ **ä¸­ç­‰åé«˜** - æ­£å¸¸æ°´æº– | é æ¸¬å¯åƒè€ƒï¼Œä½†éœ€çµåˆå…¶ä»–æŒ‡æ¨™ |
| **0.4-0.6** | ğŸŸ¡ **ä¸­ç­‰** - ç•¥æœ‰ä¸ç¢ºå®šæ€§ | é æ¸¬åƒ…ä¾›è¼”åŠ©åƒè€ƒ |
| **< 0.4** | ğŸ”´ **ä½ä¿¡å¿ƒ** - æ¨¡å‹ä¸ç¢ºå®š | é æ¸¬ä¸ç©©å®šï¼Œè¬¹æ…æ¡ä¿¡ |

### å¯¦éš›æ‡‰ç”¨å»ºè­°
1. **ä¿¡å¿ƒåº¦ 0.8+**ï¼šå¯ä»¥æ›´ç©æ¥µåœ°åƒè€ƒ LSTM çš„æ¼²è·Œé æ¸¬
2. **ä¿¡å¿ƒåº¦ 0.6-0.8**ï¼šé æ¸¬æ–¹å‘å¯åƒè€ƒï¼Œä½†é»ä½é ä¼°éœ€æ‰“æŠ˜æ‰£
3. **ä¿¡å¿ƒåº¦ 0.4-0.6**ï¼šé æ¸¬åƒ…ä¾›è¼”åŠ©åƒè€ƒï¼Œå»ºè­°æ­é…å…¶ä»–æŠ€è¡“æŒ‡æ¨™
4. **ä¿¡å¿ƒåº¦ < 0.4**ï¼šæ¨¡å‹å°ç•¶å¤©çš„åˆ¤æ–·è¼ƒä¸ç¢ºå®šï¼Œå¯èƒ½æ˜¯å› ç‚ºå¸‚å ´è™•æ–¼ç•°å¸¸æ³¢å‹•æœŸ

---

## ğŸ“š åƒè€ƒæ–‡ç» (References)

- **Pro Trader RL**: [Paper Implementation](https://arxiv.org/abs/xxxx)
- **LSTM-SSAM**: Sequential Self-Attention for time series prediction
- **MC Dropout**: Uncertainty estimation via Monte Carlo Dropout

## ğŸ“„ æˆæ¬Š (License)

MIT License

## ğŸ‘¤ ä½œè€… (Author)

Phil Liang

---

*Built with Python, TensorFlow, Stable-Baselines3, and â¤ï¸*
